# LabsSheduler

## Описание работы и возможностей

Скрипт предназначен для автоматической выдачи заданий на лабораторные работы студентам в системах Redmine, GitLab (и в будущем RocketChat). Один запуск скрипта позволяет выдать одну лабораторную работу.

Скрипт имеет следующие параметры запуска:
   * ID лабораторной работы;
   * длительность лабораторной работы (количество дней, отводимых на выполнение);
   * ID трекера задачи в Redmine;
   * ID группы в Redmine, всем студентам которой надо выдать лабораторную;
   * режим:
       * 1 -- выдача лабораторной работы только в Redmine;
       * 2 -- выдача лабораторной работы только в Gitlab;
       * 0 -- выдача во всех системах;
   * путь к настроечному файлу.
   
При выдаче лабораторной работы в **Redmine** создается проект, в названии которого указывается ID лабораторной работы, а в описании содержится её условие. В проект могут быть вложены дополнительные файлы, требуемые для выполнения лабораторной. Группа студентов добавляется в участники проекта. Далее каждому студенту создается и назначается задача. В описании задачи содержится вариативная часть лабораторной (в виде строки текста; это опционально - если лабораторная не предусматривает вариантов, описание задачи будет пустым). Указывается дата начала работы над задачей (start_date), равная дате запуска скрипта, и плановая дата окончания работы (due_date), равная start_date + длительность лабораторной работы.

При выдаче лабораторной работы в **Gitlab** создается группа репозиториев, в названии которой указывается ID лабораторной работы. Далее для каждого студента создается репозиторий (в терминологии Gitlab репозиторий == проект) с настроенным веб-хуком, реагирующим на события merge request'а. Доступ студенту выдается только в его репозиторий.

## Первоначальная настройка
Для первоначальной настройки требуется выполнить следующие шаги:
1. Установить и запустить Redmine, Gitlab на каком-либо сервере (серверах).
2. Подготовить Redmine:
    * добавить родительский проект, например, OII_2022-2023;
    * добавить пользователей-студентов;
    * добавить группу пользователей, добавить в неё всех студентов;
    * включить доступ к API (Администрирование -> настройки -> API -> "Включить веб-сервис REST");
    * добавить технического пользователя, от имени которого будут добавляться задачи, сделать его администратором;
    * выполнить прочие необходимые Вам настройки, например, добавить роли и трекеры.
3. Подготовить Gitlab:
    * добавить родительскую группу репозиториев, например, OII_2022-2023;
    * добавить пользователей-студентов;
    * добавить технического пользователя, от имени которого будут добавляться репозитории, создать ему токен доступа к API (User Settings -> Access Tokens, выбрать api), **сохранить себе этот токен, т.к. после закрытия страницы он исчезнет**.

4. Заполнить настроечный файл settings.ini.  
```
[Redmine]  
# хост, где запущен Redmine
redmine_host = http://studvesna.bmstu.ru/    

# токен доступа к API;
# для получения зайти под техническим пользователем-администратором, 
# нажать Моя учетная запись -> справа найти поле Ключ доступа к API -> нажать Показать
redmine_key = 1234

# префикс названий проектов; 
# пример названия проекта с таким префиксом: OII_lab_01
project_name_prefix = OII_lab_

# идентификатор родительского проекта;
# Проекты -> выбрать родительский проект, созданный на шаге 2, -> в строке браузера будет идентификатор, 
# например для http://studvesna.bmstu.ru/projects/oii_2022-2023 это oii_2022-2023
project_parent_id = oii_2022-2023

# идентификатор группы студентов, созданной на шаге 2;
# Администрирование -> Группы -> выбрать группу -> в строке браузера будет идентификатор,
# например для http://studvesna.bmstu.ru/groups/9/edit это 9
project_member_group_id = 9

# идентификатор роли, которую будут иметь студенты в проекте;
# Администрирование -> Роли и права доступа -> выбрать роль -> в строке браузера будет идентификатор,
# например для http://studvesna.bmstu.ru/roles/4/edit это 4
project_member_role_id = 4

# префикс названий задач;
# пример названия задачи с таким префиксом: Лабораторная работа №01
issue_subject_prefix = Лабораторная работа №

# приоритет задачи
issue_priority_id = 1

# префикс описаний задач
# в описании задачи указываем вариативную составляющую лабораторной, поэтому префикс может быть, например, "Вариант:"
issue_descr_prefix = Вариант:

[Gitlab]
# хост, где запущен Gitlab
gitlab_host = https://git.iu7.bmstu.ru/

# токен доступа к API, созданный на шаге 3
gitlab_token =

# ID родительской группы репозиториев
# Группы -> найти группу, созданную на шаге 3 -> внизу под названием будет Group ID 
group_parent_id = 1520

# префикс названий групп
# пример названия группы с таким префиксом: OII_lab_01
group_name_prefix = OII_lab_

# веб-хук, реагирующий на события merge request'а
hook_url = http://host:port/

# метки, которые надо добавить в проект (доступны при merge request'е)
# перечисление через запятую в виде название:цвет
# опционально
project_labels = плагиат:#ff0000, мод:#0000ff

# роль студента в проекте (30 -- девелопер)
project_access_level = 30

# дата, когда закончится доступ в формате YYYY-mm-dd
# опционально
project_access_expires_at = 2022-12-31

[Files]
# путь к директории, где будут храниться условия лабораторных работ
labs_dir = /path/to/labs
```
6. Установить зависимости (библиотеки, необходимые для работы скрипта):
    ```
    pip3 install python-redmine python-gitlab
    ```

## Выдача лабораторных работ
Для автоматической выдачи лабораторных работ требуется выполнить следующие шаги:
1. Подготовить задания на лабораторные работы в файлах со следующей структурой:
```
/path/to/labs  
│
└───01
│   │   variants.txt (опционально)
│   │
│   └───descr
│       │   description.txt
│       │   additional_file.txt
|       │   yet_another_additional_file.png
│       │   ...
│   
└───02
    │   ...
```
где:\
**variants.txt** содержит вариативную часть лабораторной, каждый вариант с новой строки, заголовка нет, например
```
Алгоритм 1
Алгоритм 2
Алгоритм 3
...
```
Номер варианта студента определяется как (stud_num-1 % vars_count) + 1, где stud_num - номер строки студента в файле students, vars_count - количество вариантов (строк в файле variants.txt).\
**descr/description.txt** содержит условие лабораторной работы.\
Прочие файлы в директории **descr** будут добавлены как файлы в модуль файлов проекта Redmine.

2. Запустить скрипт main.py. Доступна подсказка:
```
> python3 main.py -h
usage: main.py [-h] [-d DURATION] [-t TRACKER] [-m MODE] num group_id                  
                                                                               
Параметры запуска:                                                             
                                                                               
positional arguments:                                                          
  num                   ID лабораторной работы, например, 01       
  group_id              ID группы студентов в Redmine, например, 9           
                                                                               
optional arguments:                                                            
  -h, --help            show this help message and exit                        
  -d DURATION, --duration DURATION                                             
                        Длительность лабораторной работы, дни (по-умолчанию 14)
  -t TRACKER, --tracker TRACKER                                                
                        ID трекера задач в Redmine (по-умолчанию 1)
  -m MODE, --mode MODE  
                        Режим запуска: 
                        1 -- выдача только в Redmine, 
                        2 -- выдача только в Gitlab,
                        0 -- выдача во всех системах (по-умолчанию 0)                      
  -s SETTINGS, --settings SETTINGS
                        Путь к настроечному файлу (по-умолчанию ./settings.ini)

```
Пример запуска: ```python3 ./src/main.py 01 9 -m 0 -d 28 -t 5 -s ./settings/oii.ini```
