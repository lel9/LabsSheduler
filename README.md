# LabsSheduler

## Описание работы и возможностей

Скрипт предназначен для автоматической выдачи заданий на лабораторные работы студентам в системах Redmine, GitLab (и в будущем RocketChat). Один запуск скрипта позволяет выдать одну лабораторную работу.

Скрипт имеет следующие параметры запуска:
   * ID лабораторной работы;
   * длительность лабораторной работы (количество дней, отводимых на выполнение);
   * ID трекера задачи в Redmine;
   * режим:
       * 1 -- выдача лабораторной работы только в Redmine;
       * 2 -- выдача лабораторной работы только в Gitlab;
       * 0 -- выдача во всех системах;
   
При выдаче лабораторной работы в **Redmine** создается проект, в названии которого указывается ID лабораторной работы, а в описании содержится её условие. В проект могут быть вложены дополнительные файлы, требуемые для выполнения лабораторной. Группа студентов добавляется в участники проекта. Далее каждому студенту создается и назначается задача. В описании задачи содержится вариативная часть лабораторной (в виде строки текста; это опционально - если лабораторная не предусматривает вариантов, описание задачи будет пустым). Указывается дата начала работы над задачей (start_date), равная дате запуска скрипта, и плановая дата окончания работы (due_date), равная start_date + длительность лабораторной работы.

При выдаче лабораторной работы в **Gitlab** создается группа репозиториев, в названии которой указывается ID лабораторной работы. Далее для каждого студента создается репозиторий (в терминологии Gitlab репозиторий == проект) с настроенным веб-хуком, реагирующим на события merge request'а. Доступ студенту выдается только в его репозиторий.

## Первоначальная настройка
Для первоначальной настройки требуется выполнить следующие шаги:
1. Установить и запустить Redmine на каком-либо сервере.
2. Подготовить Redmine:
    * добавить родительский проект, например, OII_2022-2023;
    * добавить пользователей-студентов;
    * добавить группу пользователей, добавить в неё всех студентов;
    * включить доступ к API (Администрирование -> настройки -> API -> "Включить веб-сервис REST");
    * добавить технического пользователя, от имени которого будут добавляться задачи, сделать его администратором;
    * выполнить прочие необходимые Вам настройки, например, добавить роли и трекеры.
3. Подготовить Gitlab:
    * добавить родительскую группу репозиториев, например, OII_2022-2023;
    * добавить пользователей-студентов;
    * добавить технического пользователя, от имени которого будут добавляться репозитории, создать ему токен доступа к API (User Settings -> Access Tokens, выбрать api), **сохранить себе этот токен, т.к. после закрытия страницы он исчезнет**.
4. Заполнить файл со списком студентов. Формат .csv, поля разделяются символом табуляции, в первой строке находится заголовок.
    * для получения **redmine_id** в Redmine зайти во вкладку Администрирование -> Пользователи -> выбрать пользователя -> в строке браузера будет id, например для http://studvesna.bmstu.ru/users/8/edit это 8;
    * **gitlab_un** - это username пользователя в Gitlab. По-умолчанию равен части email пользователя до знака @, для изменения нужно зайти во вкладку User Settings -> Account -> раздел Change username.
```
stud_xx	xxx@student.bmstu.ru	telegram_id	rocketchat_id	redmine_id	gitlab_un	eu_id
stud_01	kek1@student.bmstu.ru	1	1	8	stud_01	1
stud_02	kek2@student.bmstu.ru	2	2	10	stud_02	2
stud_03	kek3@student.bmstu.ru	3	3	11	stud_03	3
``` 

5. Заполнить настроечный файл settings.ini.  
```
[Redmine]  
# хост, где запущен Redmine
redmine_host = http://studvesna.bmstu.ru/    

# токен доступа к API;
# для получения зайти под техническим пользователем-администратором, 
# нажать Моя учетная запись -> справа найти поле Ключ доступа к API -> нажать Показать
redmine_key = 1234

# префикс названий проектов; 
# пример названия проекта с таким префиксом: OII_lab_01
project_name_prefix = OII_lab_

# идентификатор родительского проекта;
# Проекты -> выбрать родительский проект, созданный на шаге 2, -> в строке браузера будет идентификатор, 
# например для http://studvesna.bmstu.ru/projects/oii_2022-2023 это oii_2022-2023
project_parent_id = oii_2022-2023

# идентификатор группы студентов, созданной на шаге 2;
# Администрирование -> Группы -> выбрать группу -> в строке браузера будет идентификатор,
# например для http://studvesna.bmstu.ru/groups/9/edit это 9
project_member_group_id = 9

# идентификатор роли, которую будут иметь студенты в проекте;
# Администрирование -> Роли и права доступа -> выбрать роль -> в строке браузера будет идентификатор,
# например для http://studvesna.bmstu.ru/roles/4/edit это 4
project_member_role_id = 4

# префикс названий задач;
# пример названия задачи с таким префиксом: Лабораторная работа №01
issue_subject_prefix = Лабораторная работа №

# трекер, которому будет принадлежать задача (Bug/Feature/Support/свой трекер);
# Администрирование -> Трекеры -> выбрать трекер -> в строке браузера будет идентификатор,
# например для http://studvesna.bmstu.ru/trackers/2/edit это 2
issue_tracker_id = 2

# префикс описаний задач
# в описании задачи указываем вариативную составляющую лабораторной, поэтому префикс может быть, например, "Вариант:"
issue_descr_prefix = Вариант:

[Gitlab]
# хост, где запущен Gitlab
gitlab_host = https://git.iu7.bmstu.ru/

# токен доступа к API, созданный на шаге 3
gitlab_token =

# ID родительской группы репозиториев
# Группы -> найти группу, созданную на шаге 3 -> внизу под названием будет Group ID 
group_parent_id = 1520

# префикс названий групп
# пример названия группы с таким префиксом: OII_lab_01
group_name_prefix = OII_lab_

# веб-хук, реагирующий на события merge request'а
hook_url = http://host:port/

[Files]
# путь к файлу со списком студентов, созданному на шаге 4
students = /path/to/students/students.csv

# путь к директории, где будут храниться условия лабораторных работ
labs_dir = /path/to/labs
```
6. Установить зависимости (библиотеки, необходимые для работы скрипта):
    ```
    pip3 install python-redmine python-gitlab
    ```

## Выдача лабораторных работ
Для автоматической выдачи лабораторных работ требуется выполнить следующие шаги:
1. Подготовить задания на лабораторные работы в файлах со следующей структурой:
```
/path/to/labs  
│
└───01
│   │   variants.txt (опционально)
│   │
│   └───descr
│       │   description.txt
│       │   additional_file.txt
|       │   yet_another_additional_file.png
│       │   ...
│   
└───02
    │   ...
```
где:\
**variants.txt** содержит вариативную часть лабораторной, каждый вариант с новой строки, заголовка нет, например
```
Алгоритм 1
Алгоритм 2
Алгоритм 3
...
```
Номер варианта студента определяется как (stud_num-1 % vars_count) + 1, где stud_num - номер строки студента в файле students, vars_count - количество вариантов (строк в файле variants.txt).\
**descr/description.txt** содержит условие лабораторной работы.\
Прочие файлы в директории **descr** будут добавлены как файлы в модуль файлов проекта Redmine.

2. Запустить скрипт main.py. Доступна подсказка:
```
> python3 main.py -h
usage: main.py [-h] [-d DURATION] [-t TRACKER] [-m MODE] num                   
                                                                               
Параметры запуска:                                                             
                                                                               
positional arguments:                                                          
  num                   ID лабораторной работы, например, 01                   
                                                                               
optional arguments:                                                            
  -h, --help            show this help message and exit                        
  -d DURATION, --duration DURATION                                             
                        Длительность лабораторной работы, дни (по-умолчанию 14)
  -t TRACKER, --tracker TRACKER                                                
                        ID трекера задач в Redmine (по-умолчанию 2 -- Feature)
  -m MODE, --mode MODE  
                        Режим запуска: 
                        1 -- выдача только в Redmine, 
                        2 -- выдача только в Gitlab,
                        0 -- выдача во всех системах (по-умолчанию 0)
```
Пример запуска: ```python3 main.py 01 -m 0 -d 28 -t 5```
